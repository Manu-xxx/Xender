package com.hedera.services.state.merkle;

import com.hedera.services.state.submerkle.EntityId;
import com.hedera.services.state.submerkle.FcTokenAllowanceId;
import com.hedera.services.state.submerkle.TokenAssociationMetadata;
import com.hedera.test.serde.SelfSerializableDataTest;
import com.swirlds.common.constructable.ClassConstructorPair;
import com.swirlds.common.constructable.ConstructableRegistry;
import com.swirlds.common.constructable.ConstructableRegistryException;

import java.util.Collections;

import static com.hedera.services.state.merkle.MerkleAccountState.RELEASE_0230_VERSION;
import static com.swirlds.common.CommonUtils.unhex;

public class MerkleAccountStateSerdeTest extends SelfSerializableDataTest<MerkleAccountState> {
	@Override
	protected Class<MerkleAccountState> getType() {
		return MerkleAccountState.class;
	}

	@Override
	protected void registerConstructables() throws ConstructableRegistryException {
		ConstructableRegistry.registerConstructable(
				new ClassConstructorPair(EntityId.class, EntityId::new));
		ConstructableRegistry.registerConstructable(
				new ClassConstructorPair(FcTokenAllowanceId.class, FcTokenAllowanceId::new));
	}

	@Override
	protected int getNumTestCasesFor(int version) {
		return version == RELEASE_0230_VERSION ? hexed024Forms.length : hexed025Forms.length;
	}

	@Override
	protected byte[] getSerializedForm(final int version, final int testCaseNo) {
		return unhex(version == RELEASE_0230_VERSION ? hexed024Forms[testCaseNo] : hexed025Forms[testCaseNo]);
	}

	@Override
	protected MerkleAccountState getExpectedObject(final int version, final int testCaseNo) {
		if (version == RELEASE_0230_VERSION) {
			return new MerkleAccountState(
					propertySource.nextKey(),
					propertySource.nextUnsignedLong(),
					propertySource.nextUnsignedLong(),
					propertySource.nextUnsignedLong(),
					propertySource.nextString(100),
					propertySource.nextBoolean(),
					propertySource.nextBoolean(),
					propertySource.nextBoolean(),
					propertySource.nextEntityId(),
					propertySource.nextInt(),
					propertySource.nextUnsignedInt(),
					propertySource.nextByteString(36),
					propertySource.nextUnsignedInt(),
					// This migration relied on the fact that no 0.24.x production state ever included allowances
					Collections.emptyMap(),
					Collections.emptyMap(),
					Collections.emptySet());
		} else {
			final var seeded = new MerkleAccountState(
					propertySource.nextKey(),
					propertySource.nextUnsignedLong(),
					propertySource.nextUnsignedLong(),
					propertySource.nextUnsignedLong(),
					propertySource.nextString(100),
					propertySource.nextBoolean(),
					propertySource.nextBoolean(),
					propertySource.nextBoolean(),
					propertySource.nextEntityId(),
					propertySource.nextInt(),
					propertySource.nextUnsignedInt(),
					propertySource.nextByteString(36),
					propertySource.nextUnsignedInt(),
					// This migration relied on the fact that no 0.24.x production state ever included allowances
					propertySource.nextGrantedCryptoAllowances(10),
					propertySource.nextGrantedFungibleAllowances(10),
					propertySource.nextApprovedForAllAllowances(10));
			seeded.setTokenAssociationMetadata(new TokenAssociationMetadata(
					propertySource.nextUnsignedInt(), propertySource.nextUnsignedInt(), propertySource.nextPair()));
			return seeded;
		}
	}

	private static final String[] hexed024Forms = {
			"0100000000000000020000000000eefa560000000000000021ecbd0164c7e14ea4dfc65fb5a41b7b496d197a616f3890c9cf98c1f9941dbd44f87880b534d4ed213f056d21236f5d9934694c03bb0b91addc000000645b4162646e68380369423f1c26107c6a6169621134177b5c1b412f6458546b31240e35784a16517b442e4f73441d7b4d64320b481d166d1318691a514a3b7b793d1b48740c4150114a1538060c240d552953786d6f373756232978187c3801444d5c295600000101f35ba643324efa370000000142dec2d45bf6488e3be6b268d29cdcaf687c1ce5e74d43e200000000000000001a53943eb5b28b1800000024a859534a7dc1f7d50d74e54ae9191ec2ad7374a9804801009be71f46c090440b3893482b75597cc6000000000000000000000000",
			"0100000000000000020000000000ecf2ea0000000000000020c09c3631dd99bfc3402344dd5538dedf8ab233e251c34e79ca4fec686f859441429d7eeca015d4da0b273bbad05c1c2808ca51a7910de14b00000064047a3a3452137559202905745a5b0f7270310d0e00436a55622c39246c195f40414d113464172a10196b1d553e120a753f11521b527e5a7326511166727869661f227e50164c2d4533073f41233910323b6c5d4b2e7946786c4c0464093d62011a44383b00010001f35ba643324efa37000000011e0edbd00fcce0901fd4d02967db2dc474a7df70a6c9377700000000000000007e144b2a82128f7a00000024d4295dc5b304c82f0e40b56d276f657af230a9c98953db3b479095d3a552c36343b9bb8b6f41f8ac000000000000000000000000",
			"0100000000000000020000000000ef843a0000000000000024565456a617c70d53752f3aec85623226c721dc2add366bec0dca4a06e5476314013aaff869dfcd95d5b653517432b2dc9ee26d0215eae21462de5b8800000064420f4b4a4d146f4d6d62022e0d15290972010e4c04677760004018703a62616a6909411c6c7238151d302a322d22751f4c0d063e61773e1d2c197e2914442331015b641037712d6c0a026f232314376b1c52174b3d35682c517157486137194e0959231800000001f35ba643324efa37000000014d45530b3ebbfc795e6735621760f9be3001ed8477f5ea5900000000000000007d88ed2dd4dc1ade000000241945caf6e10db757da1b820da3254237c4dc243544e172102079e0530ca26cb021e42bf834c37248000000000000000000000000",
			"0100000000000000020000000000ecb1f000000000000000780000000200000000000000020000000000ef843a00000000000000244b7ada2a1fc3469001efca4b4e7dda1a34ea7e6396d6afdfde873d4df57c136a950e082a00000000000000020000000000ecf2ea0000000000000020df4ddb8efc34c44d33dce3576d60262e04d19b1a424472b4b5f06c5cf028c75b3eef19647108bbb67371b138ae278551117a9d528e701b1200000064722f660112322137047c032e5d6e06297a74091c0d35585a241d405615436e744d36205913085a0e25165f21032d646c7d575d6c1041350a2e001212032e4b28371645795f1f045d6f495726040a1a56462705027c33616e3c45295e70323950681b435100000101f35ba643324efa37000000012ce0291fcf1ddd122b26e628e59ad4d81f440e71c0f55a3b00000000000000003cdb87ee63c68e7500000024e7ef1b0e049e8b4652e949799b3609a5d6a0e2fe2eead8b1fcd16955460c5b25e04cc3cf4e82e4df000000000000000000000000",
			"0100000000000000020000000000ed33e400000000000000181be08087d85ced322940a1ea80f22bfa1a44e90beef821d325a8a48bfe1752c12f6310f856e1dcbb70a7cc375d760ad9000000643e3a7c17393d174951764d5f1964581f450b3c7a3a774e66070c097770640e095d68092a576d75036b694977484e782e430a530a127c1b527a500f20211740480a493d23295a4f2e32162a38460f6a3b4804680346066f2f055e0f3c7a1a246b5169166801000101f35ba643324efa37000000012c1939ccac5090c47e1cdcb7e97dbb5959488af38801dc6b000000000000000041fb2a015b28281c00000024fa0be1cb308140ec3f776d2606a8e52ba93f3c2e7538a22cefb065013fd9384df74e4dcf09058d9f000000000000000000000000",
	};

	private static final String[] hexed025Forms = {
			"0100000000000000020000000000eefa560000000000000021af5556d292cbe652433f774c092d99dedc9e8d26ad4a8ab03dadfebaf5fdfb0f9f5f7056ef28df1a0d6afb130435ce70966daf86ae3bd0b3b100000064082f2f261b3308761e55543a3955641b2b1a711d22360a0c0a094a32516f5865466c4b282247066e7214012e5a773d4d194a13435f733874380b0603024c08122a1c4b33267607304578212c5b55042c7a35024c273f3c094d52626120280407252d6b3601010001f35ba643324efa370000000156411e8a943c430f2361ec48cfe945c513f3f35f74d43f28000000000000000059198006d747d59f00000024ecae67246a2be581ee62078b3d11ecec073e01e8c0a6c3fb7c06ef62346b475809f237e706d7779b0000000a00000000c73f96cd260eabfa526de4fc00000000d21411025101afc6d8385bab00000000d7dabd56779bd2765b0813ae00000000df58c61d2651c47b24752d8400000000f140acca5820e7a13d885f5f000000000dbe7c3b1e6da99262da23bb00000000312ad4dc081934134fdc30db000000003ba8f2b4305429fe7ffb40930000000041fa335f4729c8ecd8627c8300000000761c15e509961213418c367f0000000af55baa544950f139000000018f86abae38c0488d42c9d3bdc0ad705af55baa544950f13900000001ea3e5a493499864528dfca8b7c6f709df55baa544950f13900000001f2ef0bc646ea83b01f84b5c9a42e7263f55baa544950f13900000001149b678e611ca208680af3a1e452e055f55baa544950f139000000012f69ecdefc60158e42509a92bc33a345f55baa544950f139000000013fbd25051162ab7871e4ef6dd8e8353df55baa544950f1390000000165ed4620d7d703b266e60debe6f8c910f55baa544950f1390000000175b5bc340e972a0e7129d03d239353a8f55baa544950f139000000017c64365f0af445d8336c0065a8e114e1f55baa544950f139000000017e71e958123f912610c60ba8a64a05850000000af55baa544950f13900000001947b131af51709d5f55baa544950f13900000001acfd4c05a6a0891bf55baa544950f13900000001c04709b1989ee070f55baa544950f13900000001d39c8e23ec82ccfcf55baa544950f13900000001d9f5ed0c00ea6862f55baa544950f13900000001f69c87af0fd3ee44f55baa544950f139000000010c477e718916477bf55baa544950f13900000001130759d431ed20cbf55baa544950f1390000000153017d325ad3c136f55baa544950f139000000016dc99dfe16141a1e79455b5064b2d82d79abdbce6367d9de",
			"0100000000000000020000000000ecb1f0000000000000011d0000000200000000000000020000000000ed33e4000000000000001815d43ba47e4397dd091ada9a067ea7d94383f7091da7ac2200000000000000020000000000ecb1f000000000000000d10000000200000000000000020000000000ef843a00000000000000247b93b04cd1e4e2c811bb59ec9fab011e14ad587042525c58e4ad6d8b128a0d2568fdfa9d00000000000000020000000000ecb1f000000000000000790000000200000000000000020000000000ef843a00000000000000240980de2b81e1fd997325223b23a1f91b36963b31dad991f2dc1eb3768a69b1e2d06d884900000000000000020000000000eefa5600000000000000216cdd9658b8d04dab2e714e45aaee1ef072cf8acd15aa2df4570068c4242795d1e266026c4d95b06d93461c7c8f4d48efba6cde09524dd0f7dc000000644c176a3f1b26476e6a3376230e6b25356a09160f78294a4365790a0e62252131692b713e7116441d660d7e7226421b15682930535d666624395d201a235c131d474b6854762d044b633f6506011e712133173d2b2c2d7a756b4d562b6c24530a5367306e01010001f35ba643324efa37000000011c6116ad9c7b38187630b409652fd113693ec9fb92f4ff73000000000000000052dd9112ca84e53d00000024fdc4af7c623c97e3924188a943a968961dd6239248c3d9a65ebd6f83f2d80bf52f3b754910f005480000000a000000009109db6452814cc7aef1272a00000000a2400e531c57b26200e5b4a200000000a71874f73625df7e4e6ec73300000000c9525ef16807f0ef61fe350300000000ce202919076316e14f39702d0000000000bc550601019380b3fdbd940000000011b84a4d3c8f6ffaf3526018000000004488c9b5420b6040e757570e0000000075a04cec1c64a87931cdeeee0000000079e225ee68d71e025b06fb060000000af55baa544950f13900000001862016d98b5a1add54f96e7bb95b332af55baa544950f1390000000195eae96f90315ab94cb64f841263f0e4f55baa544950f13900000001abe697658401b97a1854a7d9df65fd6cf55baa544950f13900000001b95f85824f81c6a923ea8f2a2029ef69f55baa544950f13900000001fd4b5bf5c8067e916e6a995b4b586735f55baa544950f1390000000106eacb3045be91a375321724351dcefef55baa544950f1390000000115b663a1fb8a790719d22e1074075e86f55baa544950f13900000001279ed4aee504d3be623da1d09e5177c4f55baa544950f139000000014cb9f8c7fc2a39162066a8539380eb82f55baa544950f13900000001558ba28d5af24f545560e7bd044d28f80000000af55baa544950f139000000018b020bf84502a791f55baa544950f139000000019a23024c355d17f2f55baa544950f13900000001ddf3a69f94f38b4df55baa544950f13900000001ddfa0e842b79719af55baa544950f13900000001ecb45046031283cef55baa544950f139000000011f01ce380a50353bf55baa544950f139000000011f748ee804c504c4f55baa544950f1390000000140339a3509eb3025f55baa544950f1390000000178c26433606a3522f55baa544950f139000000017a8a2f23ce4ea286799e17ba4d82eb70ecd1fe0585a8be2b",
			"0100000000000000020000000000ef843a000000000000002457578d53457099bd2d8f7457492296c73a184f1dff41cce87ddfc9356ba1e798ae46c1ce5d4f1cf332871d2566b925190278bc3f3eb02c29565c48c7000000640e4b7351446b2e542d3167245f1d1712581e2563505065293d4a741c5e6a0171330e4136611a726e79441c3213311658636b77310b1c5b553824396b6c3c5f2f2655445a11735b6f7704650e431a3f04630f2326504c5811085812365a3e50613d60346100000101f35ba643324efa37000000015b5ae0c034856b007fdf6c87df4f88801fc25852f3c4636800000000000000006ee588f183462f35000000243f596b02a9add4936038f38accf073b561cb395ef2fa309a15fdf9d3d7c407dbc24b3a40024e40710000000a0000000089aa23c5517cbf9a9e49edc8000000008bfa068c33e5a06efee8bfe900000000d821b2763dad0ff933284b0700000000df38fd5e4a1fdb5585cf9df4000000004af44a3b1bf62aaa188d95dd00000000595d408a7864e4b5e0b43d10000000005e8004957f7d1d8e07a212d100000000697f2a3a27e691fb39825e2b000000006e80aea730a543f00107b61e0000000076b3d71b34226bcfc4e49a6b0000000af55baa544950f139000000018de07dedaa20ad1a6247dceb211c502ff55baa544950f13900000001ac48201c07763bd0153761860af824bbf55baa544950f13900000001ace13f34fdfc7f51672df01a3884b63df55baa544950f13900000001fa0e1e9b80d20fbb6809012e17226fcff55baa544950f13900000001fa4773402275eebc172d3bccfba0bf17f55baa544950f13900000001016a675a773d0b0a2905d501cd33e625f55baa544950f139000000012ebfa4aadd73620426156e76388f4e50f55baa544950f139000000013cea512fd92b73075ba7abdd17943d3af55baa544950f139000000014a4df4d69aaecdea03082e3784cb28bdf55baa544950f13900000001589186c09d69205345b7487f7c90b7f10000000af55baa544950f1390000000184dd34dc720ce779f55baa544950f1390000000185530f2016746940f55baa544950f1390000000194c1f850d1a91de3f55baa544950f13900000001b486320434a70af2f55baa544950f13900000001f7c24cc8b0246a42f55baa544950f13900000001f95a9d3949f138d0f55baa544950f139000000010150d358e04c5dbef55baa544950f1390000000178749ef336ba78c3f55baa544950f1390000000178b2a3dcc7315d08f55baa544950f139000000017a49f35d608fed4f6c61816e11cc4a745f454d87b9fb38c7",
			"0100000000000000020000000000ecb1f000000000000000750000000200000000000000020000000000eefa560000000000000021e47ee9b088382825beb9279f729afb769f358c0de7964fab19065e9c39fc39c05b00000000000000020000000000ecf2ea00000000000000209906638a80aa3ba4edd5267765e842fa696d505a5c3a679e8d5fda4718c1d22c297f960981b0d75175bcbe32556dd0d40d0291e57f5bfda8000000647c34010b065d5f6e2710502f2554632a0e47030b391641247410447a162360423a037c0f346e5b2f2208490d141e375c46205f6e12591809390b214c6f5c726f01261d0c41095036595f080b395d1045613f091b7b1d7b77304e611275781a6d746a113700000001f35ba643324efa370000000117e069acaa1d2ded648d0d9b67261cea0b785b947a172157000000000000000058d44c1642f12db700000024615bc0d744e82247586b8811879c1a435f94ebfbc014e3017137cedaabfe312f8551aec1091a6fd50000000a0000000089bf300d4b455412626791c300000000db3f966b1b4212b43141070e00000000e48e7cac10cfb7c0b8c47f7f000000000b1285b214139b0c411c1256000000001689b7e52dda302c62387b77000000002829fbb217a88677805b7f57000000004b9abc7b2d94bc1bc30e5fdc000000005b8707a27b6554dc9fdf80e8000000006e971af00ea12d41bf195e92000000006fca859a362e7146e252c2e20000000af55baa544950f13900000001aac645fa74b977c83b2749fcf43d4ae8f55baa544950f13900000001b69089d1c45514315c506bde31940663f55baa544950f13900000001c5f4e0f8446682a06a85ea066990842ff55baa544950f13900000001de0aa2151f1467c80d4198ef46de0a95f55baa544950f13900000001fc9be229c15ebb39210396aca25a5c70f55baa544950f139000000010c00488e949de6857067d25e7adf47c7f55baa544950f1390000000122fc6dda1e7b65b030f23b3eaecc9b08f55baa544950f139000000014385df5f51103b7954299ec2b257fe2ff55baa544950f139000000015c6e5ff3ec3dbd345cca89d225baee4cf55baa544950f139000000016a3ee434daf40e83583f64e40a4a587a0000000af55baa544950f13900000001828f8e315d1182d7f55baa544950f139000000018ecd05aed09cadcaf55baa544950f1390000000194ac26e3c046691ff55baa544950f13900000001ac3460aa023cdb66f55baa544950f13900000001b6ec20ec2d4c76e8f55baa544950f139000000011f1ad417e009d4b7f55baa544950f139000000014393be1686037e42f55baa544950f1390000000145bda03dbf123d3ef55baa544950f139000000015b7a8949d16c3e93f55baa544950f1390000000167b6094fcacd4832542c352b69de6d66601b04b5eb28bf85",
			"0100000000000000020000000000ed33e400000000000000180a136f30b45ac95b4ed0b8ae04e8f3be25cf68a6143c8e563b1290a9db5cf21747a7a0b8920688992e54bb52b731c624000000646d695b2b120e1f2f265661514e6829462130743568043e51750f3c37300b0c741217406951641b23504d3770545b4135425a5d583110553141726370294a362c3c0c7b647e0300796a0a4570387d397a1e646c5f24707d0b70360758781d57671422123f01000001f35ba643324efa37000000010261c778cf054af55ad9a548d279957e39867ae1e18da4550000000000000000514a32cde4961112000000240b88fd2748c29f02d3ad42acae82ea9c70d337614475239be14e84b0ad023ee6eae351c11806e8240000000a000000008406a0bd30989b6ce934523c000000008fcd6327223d985240815dfc000000009789015b48bf0174845dd1b400000000a13a4afd56eb723a229fd8e300000000eb24436054aade7bd7aa52fd00000000f3ece49e0642e01d3c62531000000000f73532304a6d38b4a4841a48000000003908382f6c67c27020765e5a00000000587b1e2869af3efb6a306a830000000073bc363569e827bf9a570a940000000af55baa544950f1390000000183f0961d236b8215431c6fd301d1ab3cf55baa544950f13900000001ce94a2f72694e0cc1e832c263d540a56f55baa544950f13900000001d6d777f03ec425b25c5a31443114f445f55baa544950f13900000001deb57af627934add254a03f81317dc93f55baa544950f13900000001e17a051cf20346f713e85aaab9eaaf46f55baa544950f13900000001f7b42c295be0980e07c2a0eae81729dff55baa544950f13900000001fce0923efa03b0b50698aeb27151b700f55baa544950f13900000001004fa145ae522ebc7ce1bce2115e809ef55baa544950f1390000000131c6e6cbeddf39f02e50dc41a44aa562f55baa544950f13900000001399b147f343cd2a97a2e55255ce62c0e0000000af55baa544950f13900000001aa8057875d58ac13f55baa544950f13900000001bf3e5efbabac5748f55baa544950f13900000001d8363fb53c30a3adf55baa544950f13900000001d9f3a8bf17880104f55baa544950f13900000001e16a4e5af12ce9e8f55baa544950f13900000001225240439ea09382f55baa544950f139000000013bc112e1ecd56e39f55baa544950f139000000014adb9ba7b7e52a2bf55baa544950f139000000017a4b3f28f9fd9307f55baa544950f139000000017dbe0b83a6f860b73670c4c36be6db7f485b0124cb4373f5",
	};
}